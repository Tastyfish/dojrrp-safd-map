<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en/vox">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>SAFD Locations Map</title>
	<link rel="icon" type="image/png" href="images/favicon.png"/>
	<link href="css/bootstrap.min.css" rel="stylesheet"/>
	<link href="css/fa.min.css" rel="stylesheet"/>
	<link href="css/leaflet.css" rel="stylesheet"/>
	<link href="css/map.css" rel="stylesheet"/>
  <link href="css/fd.css" rel="stylesheet"/>
</head>
<body role="document">
	<nav class="navbar navbar-dark navbar-expand-sm bg-dark fixed-top navbar-fixed-top">
		<div class="container">
      <a class="navbar-brand">SAFD Map</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
	      <span class="navbar-toggler-icon"></span>
	    </button>
			<div class="collapse navbar-collapse" id="navbar">
				<ul class="navbar-nav me-auto mb-2 mb-sm-0">
					<li class="nav-item dropdown">
						<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" id="layerDropdown">Layers <span class="caret"/></a>
						<ul class="dropdown-menu mt-0" role="menu" aria-labelledby="layerDropdown" id="layer-list">
							<li><a class="dropdown-item" data-layer="world"><i class="fas fa-eye fa-fw fa-pull-left float-none"></i>World</a></li>
							<li><a class="dropdown-item" data-layer="stats"><i class="fas fa-eye fa-fw fa-pull-left float-none"></i>Stations</a></li>
							<li><a class="dropdown-item" data-layer="hosps"><i class="fas fa-eye fa-fw fa-pull-left float-none"></i>Hospitals</a></li>
						</ul>
					</li>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" id="stationDropdown">Stations <span class="caret"/></a>
            <ul class="dropdown-menu mt-0" role="menu" aria-labelledby="stationDropdown" id="stats-list">
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" id="hospitalDropdown">Hospitals <span class="caret"/></a>
            <ul class="dropdown-menu mt-0" role="menu" aria-labelledby="hospitalDropdown" id="hosps-list">
            </ul>
          </li>
					<li id="welcomeBtn" class="nav-item"><a class="nav-link" role="button" data-bs-toggle="modal" data-bs-target="#welcome">Help</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div id="map"></div>

	<div class="container" role="main">
		<div class="modal fade" id="welcome" role="dialog" tabindex="-1" aria-labelledby="welcomeLabel">
      <div class="modal-dialog">
        <div class="modal-content">
    			<div class="modal-header">
            <h5 class="modal-title" id="welcomeLabel">Hello.</h5>
          </div>
    			<div class="modal-body">
    				Turn on and off layers by going to <i>Layers</i> above.
            <br />
            Pan and zoom like a normal map.
    			</div>
    			<div class="modal-footer">
            <button type="button" class="btn btn-primary btn-lg" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
		</div>
	</div>

	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/leaflet.js"></script>
  <script src="js/markers.js"></script>
	<script>
		// google analytics
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-70465958-1', 'auto');
		ga('send', 'pageview');
	</script>
	<script>
		// Only show welcome screen on first launch
		if(localStorage.getItem('visited') !== '1') {
			new bootstrap.Modal(document.getElementById('welcome')).show();
		}
		localStorage.setItem("visited", 1);

		// initialize map
		const map = L.map("map", {
			zoomControl: false,
			attributionControl: false,
			minZoom: 2,
			maxZoom: 6,
			maxBounds: [[0,0],[-192, 128]],
			crs: L.CRS.Simple
		}).setView([-96, 64], 2);
		L.control.zoom({position: "topleft"}).addTo(map);

    const sIcon = L.divIcon({
      className: 'fas fa-fire-extinguisher fd-icon text-danger fa-3x',
      iconSize: [64, 64],
      iconAnchor: [32, 32],
    });
    const hIcon = L.divIcon({
      className: 'fas fa-h-square fd-icon text-primary fa-3x',
      iconSize: [64, 64],
      iconAnchor: [32, 32],
    });

    var currentMarker = null;

    function fMarker(latlong, name, icon, type, postal, internalCat, internalID) {
      const m = L.marker(latlong, {
        icon: icon,
        title: name,
        state: true,
        internalCat,
        internalID
      });
      const popup = m.bindPopup(
        `<p><b>${name}</b></p><p>${type} at ${postal}</p>`);
      m.addEventListener('click', e => {
        popup.openPopup();
        zoomToMarker(`${internalCat}-${internalID}`);
        updateHash();
      });
      return m;
    }

    // Load world tile map, as well as markers.
		const layers = {
			world: L.tileLayer("tiles/{z}/{x}/{y}.png", {
				minZoom: 2,
				maxZoom: 6,
				tms: true,
				zIndex: 0,
        state: true,
			}).addTo(map),
      stats: L.layerGroup(
        markers.stations.map((m, i) => fMarker(m[0], m[1], sIcon, 'Station', m[2], 'stats', i + 1))
      ).addTo(map),
      hosps: L.layerGroup(
        markers.hospitals.map((m, i) => fMarker(m[0], m[1], hIcon, 'Hospital', m[2], 'hosps', i + 1))
      ).addTo(map),
		};

    // Add stations and hospitals to menu as well
    function buildListMenu(list, root, catName) {
      list.forEach((m, i) => {
        const liEl = document.createElement("li");
        {
          const aEl = document.createElement("a");
          aEl.className = "dropdown-item";
          aEl.dataset.marker = `${catName}-${i + 1}`;
          {
            const checkEl = document.createElement("i");
            checkEl.className = "fas fa-square fa-fw fa-pull-left float-none";
            aEl.appendChild(checkEl);
          }
          aEl.appendChild(document.createTextNode(m[1] + " "));
          {
            const badgeEl = document.createElement("span");
            badgeEl.className = "badge bg-secondary";
            badgeEl.innerText = m[2];
            aEl.appendChild(badgeEl);
          }
          liEl.appendChild(aEl);
        }
        root.appendChild(liEl);
      });
    }
    buildListMenu(markers.stations, document.getElementById('stats-list'), 'stats');
    buildListMenu(markers.hospitals, document.getElementById('hosps-list'), 'hosps');

    // For debugging
    map.addEventListener('click', event => {
      console.log([event.latlng.lat, event.latlng.lng]);
    });

	  function setLayer(name, state) {
			if(layers[name] == null || layers[name].state == state)
				return false;

      if(state)
			  layers[name].addTo(map);
      else
        layers[name].remove();

      layers[name].options.state = state;

			return true;
		}

		function getLayer(name) {
			return layers[name].options.state;
		}

		function updateHash() {
			// generate hash
			var hash = "#l";
      var allLayers = true;
			for(var key in layers) {
        if(getLayer(key)) {
				  hash += "-" + key;
        } else {
          allLayers = false;
        }
			}
      if(allLayers)
        hash = "";

      if(currentMarker) {
        hash += hash.length > 0 ? "+" : "#";

        hash += `m-${currentMarker.options.internalCat}-${currentMarker.options.internalID}`;
      }

			// push url state
			if(hash != window.location.hash) {
				window.history.pushState(hash, hash, window.location.pathname + hash);
			}
		}

		// fn to handle layer toggling
		function updateMap(layer, btn, state) {
			if(!setLayer(layer, state))
				return;

			// update menu icons
			if(!btn) {
				btn = document.querySelector("[data-layer="+layer+"]");
			}
			if(btn) {
        const iconClasses = btn.querySelector("i.fas").classList;
				if(state) {
					iconClasses.remove("fa-eye-slash");
          iconClasses.add("fa-eye");
				} else {
					iconClasses.remove("fa-eye");
          iconClasses.add("fa-eye-slash");
        }
			}
		}

    // Zoom over to a marker: used in
    function zoomToMarker(markerHash, btn) {

      // clear old checkbox
      if(currentMarker) {
        const oldBtn = document.querySelector(`[data-marker=${currentMarker.options.internalCat}-${currentMarker.options.internalID}]`);
        if(oldBtn) {
          const iconClasses = oldBtn.querySelector("i.fas").classList;
          iconClasses.remove("fa-check-square");
          iconClasses.add("fa-square");
        }
      }

      // Actually move camera
      {
        const markerInfo = markerHash.split("-");

        try {
          const marker = layers[markerInfo[0]].getLayers()[parseInt(markerInfo[1]) - 1];
          currentMarker = marker;
          map.setView(marker.getLatLng(), 6);
        } catch(exc) {
        }
      }

      // update menu icons
			if(!btn) {
				btn = document.querySelector("[data-marker="+markerHash+"]");
			}
			if(btn) {
        const iconClasses = btn.querySelector("i.fas").classList;
				iconClasses.remove("fa-square");
        iconClasses.add("fa-check-square");
			}
    }

		////////////////////
		// set functionality on maps
		document.querySelectorAll("#layer-list>li>a").forEach(a => a.addEventListener("click", function() {
			// toggle the layer
			updateMap(this.dataset.layer, this, !getLayer(this.dataset.layer));
			updateHash();
		}));
    document.querySelectorAll("#stats-list>li>a,#hosps-list>li>a").forEach(a => a.addEventListener("click", function() {
			// toggle the layer
			zoomToMarker(this.dataset.marker, this);
			updateHash();
		}));

		///////////////
		// filter as requested
		function setFilter(hash, cxt) {
      const hashes = (hash != null && hash.length >= 1) ? hash.substr(1).split('+') : [];

      function grabHashPart(tag) {
        return hashes.find(h => h.length >= tag.length && h.substr(0, tag.length) == tag)?.substr(tag.length);
      }

      const layerHash = grabHashPart('l');
      const markerHash = grabHashPart('m-');

			if(layerHash) {
				const hashSet = layerHash.split("-");

				for(key in layers) {
					updateMap(key, null, hashSet.some(a => a == key));
				}
			} else {
				for(key in layers) {
					updateMap(key, null, true);
        }
			}

      if(markerHash) {
        zoomToMarker(markerHash);
      }
		}
		// load from url initially
		setFilter(window.location.hash, 1);
		// and also from pops
		window.addEventListener('popstate', event => setFilter(event.state, 2));
	</script>
</body>
</html>
